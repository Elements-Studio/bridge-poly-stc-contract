//# init -n test --public-keys Bridge=0x8085e172ecf785692da465ba3339da46c4b43640c3f92a45db803690cc3c4a36

//# faucet --addr Bridge --amount 10000000000

//# faucet --addr alice --amount 10000000000000000

//# faucet --addr bob --amount 10000000000000000


//# run --signers Bridge
script {
    use Bridge::SafeMath;
    use Bridge::zion_cross_chain_manager;
    use Bridge::zion_lock_proxy;
    use StarcoinFramework::STC::STC;
    use StarcoinFramework::Signer;
    use StarcoinFramework::Token;
    use StarcoinFramework::BCS;

    fun test_genesis_initialize(signer: signer) {
        let starcoin_poly_id = 318; // The poly id of aptos is 998, because the test data was from aptos

        // https://explorer.aptoslabs.com/txn/411144842/payload
        let raw_header = x"f90253a026532dd944a45455ea77d854cafa63e6da550d7a99bc022742d7a9c0eb30b695a01dcc4de8dec75d7aab85b567b6ccd41ad312451b948a7413f0a142fd40d49347948c09d936a1b408d6e0afaa537ba4e06c4504a0aea076076b2ef9012a600c981222e59820dd9713ac815f4a8a12740f7f719ab4e274a0624b8b1a16d1c095acad3d96ed588d0702fcde91db52aad4deb77f882b0ef300a0d4e4d938901e00ea4da08917593dba522a19b68413162444389bb35251dd96e3b9010000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000018275308411e1a30083029bf884641a7a0fb8810000000000000000000000000000000000000000000000000000000000000000f85f82753082ea60f85494258af48e28e4a6846e931ddff8e1cdf8579821e5946a708455c8777630aac9d1e7702d13f7a865b27c948c09d936a1b408d6e0afaa537ba4e06c4504a0ae94ad3bf5ed640cc72f37bd21d64a65c3c756e9c88c80c08008";
        zion_cross_chain_manager::init(&signer, raw_header, starcoin_poly_id);

        let license = zion_cross_chain_manager::issueLicense(&signer, Signer::address_of(&signer), b"zion_lock_proxy");
        zion_lock_proxy::init(&signer);
        zion_lock_proxy::initTreasury<STC>(&signer);
        zion_lock_proxy::receiveLicense(license);

        // Bind STC
        zion_lock_proxy::bindProxy(&signer, starcoin_poly_id, BCS::to_bytes(&@Bridge));
        zion_lock_proxy::bindAsset<STC>(
            &signer,
            starcoin_poly_id,
            b"0x00000000000000000000000000000001::STC::STC",
            SafeMath::log10(Token::scaling_factor<STC>())
        );
    }
}
// check: EXECUTED

//# run --signers Bridge
script {
    use Bridge::zion_cross_chain_manager;

    const ZION_SEAL_RLP_LEN: u64 = 67;

    fun test_relayer_change_epoch(sender: signer) {
        // Raw header from https://explorer.aptoslabs.com/txn/423551799/payload, next from the data using in `init` function
        let raw_header = x"f9027ea05184b372e6ae2815773ca979bd704b19c2e7b6ef01b35bf3640d3d1b009dee14a01dcc4de8dec75d7aab85b567b6ccd41ad312451b948a7413f0a142fd40d49347948c09d936a1b408d6e0afaa537ba4e06c4504a0aea0a26ab86306f1badbc85c923b920f550ffcce2789d991b9c4de0af78b30f14d76a0656c17096ddb120cd3ea99f6fb3395a64545eb720405215b696a42f60b43fecda0d4e4d938901e00ea4da08917593dba522a19b68413162444389bb35251dd96e3b90100000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000182ea608411e1a30083029bf884641bd99fb8820000000000000000000000000000000000000000000000000000000000000000f86082ea6083015f90f85494258af48e28e4a6846e931ddff8e1cdf8579821e5946a708455c8777630aac9d1e7702d13f7a865b27c948c09d936a1b408d6e0afaa537ba4e06c4504a0ae94ad3bf5ed640cc72f37bd21d64a65c3c756e9c88c80c080a063746963616c2062797a616e74696e65206661756c7420746f6c6572616e636588000000000000000008";
        let raw_seals = x"f8c9b841586c4d011be6f882ba544427c080ea2751f9e09fc51efbe7ea8a806375c1620d1945d567745c764a0b34579b03deb4c7dd12c7e1e18ddb8f9036234b32cf5c1800b841e110a83049be8212a0ec0cbf0bf83666acf128890b5fb7e1bf7e7002d9ebcac96ebab318bb1d46ba14208d016c42fc00e71bb81efd7be32be6b3a1bcb9fb488200b8414be6409d965f388e8e02d49db2468e621edd15bf637046f408a63b4a75c48831586ed2cf2246f27b09224ac7a1c2c7c5cea8d5fdda62cf5489954dd2855be7de00";
        zion_cross_chain_manager::change_epoch(&sender, &raw_header, &raw_seals);
    }
}
// check: EXECUTED


//
// //# run --signers alice
// script {
//     use Bridge::zion_lock_proxy;
//     use StarcoinFramework::Account;
//     use StarcoinFramework::BCS;
//     use StarcoinFramework::STC::STC;
//     use StarcoinFramework::Token;
//
//     fun alice_lock_stc(sender: signer) {
//         let to_chain_id = 318;
//         let amount = 100 * Token::scaling_factor<STC>();
//         let stc = Account::withdraw<STC>(&sender, amount);
//         let dst_addr = BCS::to_bytes<address>(&@Bridge);
//         zion_lock_proxy::lock<STC>(&sender, stc, to_chain_id, &dst_addr);
//         assert!(zion_lock_proxy::getBalance<STC>() == amount, 10001);
//     }
// }
// // check: EXECUTED
//
//
//
// //# run --signers Bridge
// script {
//     use Bridge::zion_lock_proxy;
//     use StarcoinFramework::STC::STC;
//
//     fun bridge_unlock_to_bob(sender: signer) {
//         let raw_header = x"f90229a0b1fd2c6eda50a586e227b4d99eaac13aa0c04d9116f7e38ff42ea1786cea762da01dcc4de8dec75d7aab85b567b6ccd41ad312451b948a7413f0a142fd40d4934794258af48e28e4a6846e931ddff8e1cdf8579821e5a011668cc260d9b91400b1f0b0b5f541a381f0436010ca8fd84d02166dcf5f1382a030d4d6f4ebac8007d4e7a1e526e748d2c8196431d14bb62a976f7db867bdf284a0d4e4d938901e00ea4da08917593dba522a19b68413162444389bb35251dd96e3b9010000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000018302c0748411e1a30083029bf88464215bdbad0000000000000000000000000000000000000000000000000000000000000000cc8302bf2083033450c080c080a063746963616c2062797a616e74696e65206661756c7420746f6c6572616e636588000000000000000008";
//         let raw_seals = x"f8c9b8411c292da03ef5d795eac9e8400e647bacf2d07a1d552cdac6668da1152006c72159b344a2aa45485c309c8afb1aa34cbf0c6c8c883e1c74050acd4a54098628c300b84186c2e216f3f5afaeee467b471972a8511954b94a7360c6ad59cc1e8647714e8558a236b0126fbc319634e052e510871d69e7595c7618d35f3c23388850d70e3701b8410ff9a22712af2d934548367e6739cd4d83ee29e0488f733c54b2e88eb934a9392473dd11d431a7e9dd5329da99117ef79e008cbfec84ca17dd1b98c5974136eb00";
//         let account_proof = x"b90372f90211a013969ca86df0f575060d47e6f8cda5a2f3f63066c4d421118ad0d5a9c58ee179a0f6efd9bcc13ff2b2ed24b25755c7b4d1ee416cc0528482c590560e75d4742551a0ff6ee8acfdb8d4cae1bdc917dd5a60d0b75d3cc2c0c0ccabe047d084ac7eb056a0b0ef574abbbd413ca1d9ed6ff466bbf48d4bf9e072fa53fca3d419158ccbf602a08d643a1b4b48b84cc879ddee6e76918513f6137aca8146c40d8a6ca3df6f51f4a0394bd1df6a14e52e205b82adbf1957e8f950e77af2e4a6aadebbd38659fc67d2a0253d8af70e4eb86f36deebf893aa3ed5200ae2c70a00fab85ac8ef650b26077ea0da30dca81ac661fec422311782e21b9af5fc7a5f5297bf92c6fcc045c62d0278a0bb2d76d9fc8cfafb26c6bc7e69921de9dd0eda158f307611cb04116c586314dba07386036cec9eed1868570fa11af570283d15a1b0b0382c00359d34e6ecbe5b0ca016e5edf89e57db24542a0cab17bb87e180815bdc5aab408f1014ffb4a649269ca0e12da2a05a69d6bc862d2e95cda2af9d4bdc3c15822357432d6b1c69ed195243a0bcceb5181cbab7ae8355808f627f4b06b7b1527511dce2597f998166f40279e7a0b393fc419e8774be0829d1af96d00939cc01e83c871beae7b8e93616782b8e80a0dc66bca997a2776e29c142d18d4f5247910f6fdb96dd5a604b893785cad2ad21a0b04213b006170d02f19418147086b141dad886f53fef5df45362fb9319abded380f8f18080a0e48ab7db906902942a54f51896fe085920d12f67f6be0ea5dc70167583e6735fa05fe2087d333e4e33cfaa52da5538e48ca395b899ea4109eb2fa5e29d0eb5b39c80808080a0783934fbbb0cc36c753fee657eab757ce4e27c6a21711e683ac8fcbc4b3e34018080a05c606b68aebf87f338029cc20ad0fd4864c384a10b4c074cd536447f76ff1793a05bae4d5b69c51dc13d13585eccaa6ace01883b72ecf6af1ef1973553854fab5880a072c8c70ccad3959e464a2b9eda140f01821270e8d927e20d50556398f1d0d822a0a1a0ad6da8430bb7b256a6504d7037b72cdd87f65c6152722692f626c331355880f869a02074e65ccffb133d9db4ff637e62532ef6ecef3223845d02f522c55786782911b846f8440180a0779d276821d14be71f191517061bff0312280556bcfc62a612725ccb4de9bac4a0c874e65ccffb133d9db4ff637e62532ef6ecef3223845d02f522c55786782911";
//         let storage_proof = x"b9014bf89180808080a0fbbab1628eca2e328865f70108bc185ec7b1dcdc65ffe96ebf8cb75c8c99fbd480808080a0373792e184e3aab113b241fb919c544e70463f1d832655b7b4b597cf52daf71ca00a89c2fdc5b6a44de4f9e793d815634bdcd49909048fe77d97e14934a557ffd9a0679402028fde8c80030453a49f39be0f5b9b26e4b83fa953be4b557c69526daf8080808080f871808080a02ee37464fbbf6eba3fab4d0d14f16fc5c28f0f6f11f3bb313700fcfb5e3fce43808080808080808080a095dd26741cacd23d8ed5841a744486122ceda636857b13ee4e35061f562adc4180a0b78e86127970b25a99afe67f111d17cccca098817af9310c2f4c32754d95bfd380f843a020814952a66412c24a27da8b1c18a1c65a74f2829a4eb468c0ec8b32d2ba03e7a1a0ac3634f503326e2c465e3a892745a7e4556fccd2c1c5b28e5a0b6aa065b2dad4";
//         let raw_cross_tx = x"f90196a09260c5e354a401c2f04f8bb87b6fcd0242f85c147ffd6bf6eccd050be1e0d76782013ef9016f9000000000000000000000000000000001a089b54c683ceffefaa63cc9fad84635bed3a32f60565cbaaaff0e1e86b283f8feb8c0000000000000000000000000000000000000000000000000000000000000004000000000000000000000000000000000000000000000000000000000000000800000000000000000000000000000000000000000000000000000000000000010f08ac0c1c6c8f2be528b35824755054000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000f7a696f6e5f6c6f636b5f70726f7879000000000000000000000000000000000082013e90f08ac0c1c6c8f2be528b35824755054086756e6c6f636bb85e2c307830303030303030303030303030303030303030303030303030303030303030313a3a5354433a3a5354431048b75ec5bb72e54bca2633c36ca3eb041027000000000000000000000000000000000000000000000000000000000000";
//         zion_lock_proxy::relay_unlock_tx<STC>(
//             &sender,
//             raw_header,
//             raw_seals,
//             account_proof,
//             storage_proof,
//             raw_cross_tx
//         );
//     }
// }
// // check: EXECUTED